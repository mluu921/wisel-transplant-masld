---
title: Notebook
date: today
freeze: auto
---

```{r}
library(tidyverse)
library(gtsummary)
library(survival)
library(ggsurvfit)
library(tidycmprsk)
library(marginaleffects)
library(gt)
library(patchwork)
library(tidymodels)
library(mice)
library(Hmisc)

source(here::here('src/process-data.R'))

board <- pins::board_folder(here::here('board'))

```

# Table 1: Demographics and Clinical Characteristics

```{r}
#| label: baseline-charcteristics
#| html-table-processing: none

local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    select(
      age_referral,
      sex,
      race_v2,
      marital_status,
      bmi,
      bmi_class,
      etiology_mash
    )

  tbl_summary(
    data,
    by = etiology_mash,
    label = list(
      age_referral ~ 'Age at Referral',
      sex ~ 'Sex',
      race_v2 ~ 'Race',
      marital_status ~ 'Marital Status',
      bmi ~ 'Body Mass Index (BMI)',
      bmi_class ~ 'BMI Class'
    )
  ) |>
    add_overall() |>
    add_p()
})

```

```{r}
#| label: med-comorbidity-table
#| html-table-processing: none

local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    select(
      contains('med_comorbidity'),
      etiology_mash
    )

  tbl_summary(
    data,
    by = etiology_mash,
    label = list(
      med_comorbidity_dm ~ 'Diabetes Mellitus',
      med_comorbidity_htn ~ 'Hypertension',
      med_comorbidity_hld ~ 'Hyperlipidemia',
      med_comorbidity_cad ~ 'Coronary Artery Disease'
    ),
    value = list(everything() ~ '1')
  ) |>
    add_overall() |>
    add_p()
})

```

```{r}
#| label: indication-table
#| html-table-processing: none

local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    select(
      contains('indications_lt'),
      -indications_lt_eval_other,
      etiology_mash
    )

  tbl_summary(
    data,
    by = etiology_mash,
    label = list(
      indications_lt_decomp ~ 'Decompensated Cirrhosis',
      indications_lt_alf ~ 'Acute Liver Failure',
      indications_lt_hcc ~ 'Hepatocellular Carcinoma',
      indications_lt_other ~ 'Other Ind'
    ),
    value = list(everything() ~ '1')
  ) |>
    add_overall() |>
    add_p()
})

```

```{r}
local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data |>
    select(
      eval_outcome,
      listing_outcome,
      etiology_mash
    ) |>
    tbl_summary(
      by = etiology_mash
    ) |>
    add_overall() |>
    add_p()
})

```


# Cumulative Incidence Transplant and Waitlist Removal

> The study should display competing-risks cumulative incidence rates for transplant procedures and death on the waitlist and removals due to deterioration and improvement and other reasons.

- A: Died on waitlist
- B: Removed due to deterioration
- C: Transplanted

```{r}
#| label: cuminc-plot-waitlist-removal
#| fig-width: 18
#| fig-height: 8
#| dpi: 150

local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(eval_outcome == 'Waitlisted')

  data <- data |>
    filter(time_from_waitlist_to_event > 0)

  data <- data |>
    mutate(time_from_waitlist_to_event = time_from_waitlist_to_event / 365.25)

  c <- cuminc(
    Surv(time_from_waitlist_to_event, competing_risk_waitlist) ~ etiology_mash,
    data = data
  )

  construct_cuminc_plot <- \(x) {
    x +
      add_confidence_interval() +
      add_risktable() +
      scale_x_continuous(limits = c(0, 5)) +
      scale_y_continuous(limits = c(0, 1), labels = scales::percent_format()) +
      add_pvalue(
        pvalue_fun = scales::label_pvalue(),
        caption = "Gray's test: {p.value}"
      ) +
      theme(plot.margin = margin(t = 10, r = 10, b = 10, l = 20)) +
      labs(x = 'Years since waitlisting', y = 'Cumulative incidence')
  }

  plot_a <- ggsurvfit::ggcuminc(c, outcome = 1) |> construct_cuminc_plot()

  plot_b <- ggsurvfit::ggcuminc(c, outcome = 2) |> construct_cuminc_plot()

  plot_c <- ggsurvfit::ggcuminc(c, outcome = 3) |> construct_cuminc_plot()

  p <- map(list(plot_a, plot_b, plot_c), \(x) ggsurvfit::ggsurvfit_build(x)) |>
    wrap_plots() +
    plot_annotation(
      tag_levels = list(c(
        'A',
        '',
        '',
        'B',
        '',
        '',
        'C',
        '',
        '',
        'D',
        '',
        '',
        'E'
      ))
    ) &
    theme(
      plot.tag = element_text(
        face = 'bold',
        size = 25,
        margin = margin(t = 0, r = 5, b = 0, l = 0)
      ),
      panel.grid.minor = element_blank()
    )

  # p + ggview::canvas(width = 12, height = 8)

  p
})

```

- A: Died on waitlist
- B: Removed due to deterioration
- C: Transplanted

```{r}
#| label: cuminc-table-waitlist-removal
#| html-table-processing: none

local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(eval_outcome == 'Waitlisted')

  data <- data |>
    mutate(
      time_from_waitlist_to_event = time_from_waitlist_to_event / 365.25
    )

  c <- cuminc(
    Surv(time_from_waitlist_to_event, competing_risk_waitlist) ~ etiology_mash,
    data = data
  )

  tbl_data <- c |>
    tidy_cuminc(times = 0:5)

  tbl_data <- tbl_data |>
    mutate(
      outcome = factor(
        outcome,
        levels = 1:3,
        labels = c(
          'Died on waitlist',
          'Removed due to deterioration',
          'Transplanted'
        )
      )
    )

  tbl_data |>
    select(time, outcome, strata, estimate, conf.low, conf.high) |>
    transmute(
      time,
      outcome,
      strata,
      estimate = glue::glue(
        "{scales::percent(estimate)} ({scales::percent(conf.low)}, {scales::percent(conf.high)})"
      )
    ) |>
    pivot_wider(
      names_from = strata,
      values_from = estimate
    ) |>
    group_by(outcome) |>
    gt() |>
    cols_label(time = 'Time (years)', outcome = 'Outcome')
})

```

# Finegray Model

> Several essential problems need to be resolved before the study can proceed to publication. The primary issue with this study lies in its statistical methodology for outcome assessment. The three studied events — transplant, death, and delisting status — exist in a time-dependent relationship, competing with one another. The study requires time-dependent analysis because descriptive statistics, including medians and chi-square tests, fail to show these temporal relationships. The authors should use Fine–Gray competing risks models to analyze waitlist outcomes and multi-state or cause-specific Cox models to study patient transitions from referral to evaluation and listing, as well as transplant and removal. The authors should present subdistribution hazard ratios, along with confidence intervals, to achieve more accurate risk measurement.

> The researchers should perform log-rank tests and Cox proportional hazards models with relevant clinical covariates, including age, sex, MELD or MELD-Na score, and MELD 3.0 when available, BMI class, diabetes, coronary artery disease, portal vein thrombosis, hepatocellular carcinoma, decompensation status, and center. 

```{r}
#| label: finegray-model-transplant-waitlist-removal-death
#| html-table-processing: none

out <- local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(eval_outcome == 'Waitlisted')

  data <- data |>
    filter(time_from_waitlist_to_event > 0)

  data <- data |>
    mutate(time_from_waitlist_to_event = time_from_waitlist_to_event / 365.25)

  data <- recipe(
    time_from_waitlist_to_event + competing_risk_waitlist ~
      age_referral +
        sex +
        site_name +
        bmi_class +
        med_comorbidity_dm +
        med_comorbidity_cad +
        med_comorbidity_htn +
        etiology_mash,
    data = data
  ) |>
    prep() |>
    bake(new_data = NULL)

  pred_methods <- c(
    age_referral = "",
    sex = "logreg",
    site_name = "",
    bmi_class = "polyreg",
    med_comorbidity_dm = "",
    med_comorbidity_cad = "",
    med_comorbidity_htn = "",
    etiology_mash = "",
    time_from_waitlist_to_event = "",
    competing_risk_waitlist = ""
  )

  set.seed(1)
  m <- mice::mice(data, m = 5, method = pred_methods, printFlag = FALSE)

  fits <- map(1:3, \(x) {
    fit.mult.impute(
      Surv(time_from_waitlist_to_event, competing_risk_waitlist) ~
        age_referral +
          sex +
          site_name +
          bmi_class +
          med_comorbidity_dm +
          med_comorbidity_cad +
          med_comorbidity_htn +
          etiology_mash,
      data = data,
      xtrans = m,
      fitter = crr,
      fitargs = list(failcode = x),
      pr = FALSE
    )
  })

  map(fits, \(x) {
    tbl_regression(x, exponentiate = TRUE) |>
      bold_p()
  }) |>
    tbl_merge(
      tab_spanner = c(
        '**Died on waitlist**',
        '**Removed due to deterioration**',
        '**Transplanted**'
      )
    )
})

out
```

# Logistic Regression Model - Factors Associated with Waitlisting

- MASLD Patients are More Likely to be Waitlisted 

```{r}
#| label: glm-waitlisting
#| html-table-processing: none
out <- local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    mutate(
      outcome = fct_collapse(
        eval_outcome,
        'Waitlisted' = c('Waitlisted'),
        'Not Waitlisted' = c(
          'Declined',
          'Deferred'
        )
      )
    )

  data <- recipe(
    outcome ~
      age_referral +
        sex +
        site_name +
        bmi_class +
        med_comorbidity_dm +
        med_comorbidity_cad +
        med_comorbidity_htn +
        etiology_mash,
    data = data
  ) |>
    prep() |>
    bake(new_data = NULL)

  pred_methods <- c(
    age_referral = "",
    sex = "logreg",
    site_name = "polyreg",
    bmi_class = "polyreg",
    med_comorbidity_dm = "",
    med_comorbidity_cad = "",
    med_comorbidity_htn = "",
    etiology_mash = "",
    outcome = ""
  )

  set.seed(1)
  m <- mice::mice(data, m = 5, method = pred_methods, printFlag = FALSE)

  fit <- fit.mult.impute(
    outcome ~
      age_referral +
        sex +
        site_name +
        bmi_class +
        med_comorbidity_dm +
        med_comorbidity_cad +
        med_comorbidity_htn +
        etiology_mash,
    data = data,
    xtrans = m,
    fitter = glm,
    fitargs = list(family = binomial()),
    pr = FALSE
  )

  fit |>
    tbl_regression(exponentiate = TRUE) |>
    bold_p()
})

out
```

# Logistic Regression Model - Factors Associated with Waitlisting

- Evaluation Outcome Stratified by BMI Class 

```{r}
#| label: glm-waitlisting-bmi-interaction-marginal-table
#| html-table-processing: none

out <- local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    mutate(
      outcome = fct_collapse(
        eval_outcome,
        'Waitlisted' = c('Waitlisted'),
        'Not Waitlisted' = c(
          'Declined',
          'Deferred'
        )
      )
    )

  data <- recipe(
    outcome ~
      age_referral +
        sex +
        site_name +
        bmi_class +
        med_comorbidity_dm +
        med_comorbidity_cad +
        med_comorbidity_htn +
        etiology_mash,
    data = data
  ) |>
    prep() |>
    bake(new_data = NULL)

  pred_methods <- c(
    age_referral = "",
    sex = "logreg",
    site_name = "polyreg",
    bmi_class = "polyreg",
    med_comorbidity_dm = "",
    med_comorbidity_cad = "",
    med_comorbidity_htn = "",
    etiology_mash = "",
    outcome = ""
  )

  set.seed(1)
  m <- mice::mice(data, m = 5, method = pred_methods, printFlag = FALSE)

  fit <- fit.mult.impute(
    outcome ~
      age_referral +
        sex +
        site_name +
        bmi_class * etiology_mash +
        med_comorbidity_dm +
        med_comorbidity_cad +
        med_comorbidity_htn,
    data = data,
    xtrans = m,
    fitter = glm,
    fitargs = list(family = binomial()),
    pr = FALSE
  )

  tbl <- marginaleffects::avg_comparisons(
    fit,
    variables = 'etiology_mash',
    by = 'bmi_class',
    transform = exp
  )

  tbl |>
    as_tibble() |>
    select(bmi_class, estimate, conf.low, conf.high, p.value) |>
    gt() |>
    fmt_number(estimate:conf.high, decimals = 2) |>
    fmt(p.value, fns = scales::label_pvalue()) |>
    cols_merge(
      columns = c(estimate, conf.low, conf.high),
      pattern = "{1} ({2}, {3})"
    )
})

out

```

# Logistic Regression Model - Factors Associated with Waitlisting
- Evaluation Outcome Stratified by Site 
  
```{r}
#| label: glm-waitlisting-site-interaction-marginal-table
#| html-table-processing: none
out <- local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    mutate(
      outcome = fct_collapse(
        eval_outcome,
        'Waitlisted' = c('Waitlisted'),
        'Not Waitlisted' = c(
          'Declined',
          'Deferred'
        )
      )
    )

  data <- recipe(
    outcome ~
      age_referral +
        sex +
        site_name +
        bmi_class +
        med_comorbidity_dm +
        med_comorbidity_cad +
        med_comorbidity_htn +
        etiology_mash,
    data = data
  ) |>
    prep() |>
    bake(new_data = NULL)

  pred_methods <- c(
    age_referral = "",
    sex = "logreg",
    site_name = "polyreg",
    bmi_class = "polyreg",
    med_comorbidity_dm = "",
    med_comorbidity_cad = "",
    med_comorbidity_htn = "",
    etiology_mash = "",
    outcome = ""
  )

  set.seed(1)
  m <- mice::mice(data, m = 5, method = pred_methods, printFlag = FALSE)

  fit <- fit.mult.impute(
    outcome ~
      age_referral +
        sex +
        bmi_class +
        site_name * etiology_mash +
        med_comorbidity_dm +
        med_comorbidity_cad +
        med_comorbidity_htn,
    data = data,
    xtrans = m,
    fitter = glm,
    fitargs = list(family = binomial()),
    pr = FALSE
  )

  tbl <- marginaleffects::avg_comparisons(
    fit,
    variables = 'etiology_mash',
    by = 'site_name',
    transform = exp
  )

  tbl |>
    as_tibble() |>
    select(site_name, estimate, conf.low, conf.high, p.value) |>
    gt() |>
    fmt_number(estimate:conf.high, decimals = 2) |>
    fmt(p.value, fns = scales::label_pvalue()) |>
    cols_merge(
      columns = c(estimate, conf.low, conf.high),
      pattern = "{1} ({2}, {3})"
    )
})

out
```

Removal From Waitlist Reflected Significant Impact on Survival in MASLD Patients 

# 


```{r}
#| label: survival-plot-waitlist-removal
#| fig-width: 8
#| fig-height: 8
#| dpi: 150

out <- local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    filter(listing_outcome == 'Waitlist removal')

  data <- data |>
    filter(time_from_waitlist_removal_to_death > 0)

  data <- data |>
    filter(time_from_waitlist_removal_to_death < 5000)

  data <- data |>
    mutate(
      time_from_waitlist_removal_to_death = time_from_waitlist_removal_to_death /
        365.25
    )

  survfit2(
    Surv(time_from_waitlist_removal_to_death, mortality_outcome) ~
      etiology_mash,
    data = data
  ) |>
    ggsurvfit::ggsurvfit() +
    add_confidence_interval() +
    add_risktable() +
    scale_x_continuous(limits = c(0, 5)) +
    scale_y_continuous(limits = c(0, 1), labels = scales::percent_format()) +
    add_pvalue(
      pvalue_fun = scales::label_pvalue(),
      caption = "Logrank Test: {p.value}"
    ) +
    theme(plot.margin = margin(t = 10, r = 10, b = 10, l = 20)) +
    labs(x = 'Years since Waitlist Removal', y = 'Survival')
})

out
```

```{r}
#| label: survival-plot-transplant
#| fig-width: 8
#| fig-height: 8
#| dpi: 150

out <- local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    filter(listing_outcome == 'Transplanted')

  data <- data |>
    filter(time_from_transplant_to_death > 0)

  data <- data |>
    filter(time_from_transplant_to_death < 5000)

  data <- data |>
    mutate(
      time_from_transplant_to_death = time_from_transplant_to_death /
        365.25
    )

  survfit2(
    Surv(time_from_transplant_to_death, mortality_outcome) ~ etiology_mash,
    data = data
  ) |>
    ggsurvfit::ggsurvfit() +
    add_confidence_interval() +
    add_risktable() +
    scale_x_continuous(limits = c(0, 5)) +
    scale_y_continuous(limits = c(0, 1), labels = scales::percent_format()) +
    add_pvalue(
      pvalue_fun = scales::label_pvalue(),
      caption = "Logrank Test: {p.value}"
    ) +
    theme(plot.margin = margin(t = 10, r = 10, b = 10, l = 20)) +
    labs(x = 'Years since Transplant', y = 'Survival')
})

out
```

> The researchers should perform Cox regression analysis to model post-removal survival based on the reason for removal. 


```{r}
#| label: survival-plot-waitlist-removal-reason
#| fig-width: 8
#| fig-height: 8
#| dpi: 150

out <- local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    filter(listing_outcome == 'Waitlist removal')

  data <- data |>
    filter(time_from_waitlist_removal_to_death > 0)

  data <- data |>
    filter(time_from_waitlist_removal_to_death < 5000)

  data <- data |>
    mutate(
      time_from_waitlist_removal_to_death = time_from_waitlist_removal_to_death /
        365.25
    )

  survfit2(
    Surv(time_from_waitlist_removal_to_death, mortality_outcome) ~
      waitlist_removal_recode,
    data = data
  ) |>
    ggsurvfit::ggsurvfit() +
    add_confidence_interval() +
    add_risktable() +
    scale_x_continuous(limits = c(0, 5)) +
    scale_y_continuous(limits = c(0, 1), labels = scales::percent_format()) +
    add_pvalue(
      pvalue_fun = scales::label_pvalue(),
      caption = "Logrank Test: {p.value}"
    ) +
    theme(plot.margin = margin(t = 10, r = 10, b = 10, l = 20)) +
    labs(x = 'Years since Waitlist Removal', y = 'Survival')
})

out
```

```{r}
#| eval: false

out <- local({
  data <- pins::pin_read(board, 'processed-data')

  data <- data |>
    filter(person_eval == 'yes')

  data <- data |>
    filter(listing_outcome == 'Waitlist removal')

  data <- data |>
    filter(time_from_waitlist_removal_to_death > 0)

  data <- data |>
    filter(time_from_waitlist_removal_to_death < 5000)

  data <- data |>
    mutate(
      time_from_waitlist_removal_to_death = time_from_waitlist_removal_to_death /
        365.25
    )

  coxph(
    Surv(time_from_waitlist_removal_to_death, mortality_outcome) ~
      waitlist_removal_recode,
    data = data
  )
})

out
```